<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js\force_direct.js - MIS project</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">MIS project: js\force_direct.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/Graph-Editor.html">Graph-Editor</a></li>
                            <li><a href="../classes/Restful-API-method.html">Restful-API-method</a></li>
                            <li><a href="../classes/Visualization.html">Visualization</a></li>
                    </ul>
                </div>
            </div>
            
            <div id="elements" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Elements</h2>
                </div>
                <div class="bd">
                    <ul>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>js\force_direct.js/<ul></ul></li><li>js\pattern_graph.js/<ul></ul></li><li>js\rest.js/<ul></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>js\force_direct.js</h4>

<pre class="code prettyprint linenums">
/**
 * ### 視覺化搜尋工具
 *
 * @class Visualization
 */

var width = window.innerWidth - 10,
	height = window.innerHeight - 20,
	color = d3.scale.category10();
var width = window.innerWidth - 10, height = window.innerHeight - 20, color = d3.scale.category10();

nodeFocus = false;
edgeFocus = false;
currentBrush = [0, 0];
docHash = {};
allLinks = [];
currentScale = 0;

var path;

var highlight_nodes = [];
var highlight_edges = [];
var filtered_nodes = [], filtered_edges = [];

var gD3;
var nodes_ori = [], links_trade = [], links_branch = [];

console.log(&#x27;慶昌葯房 正法明藥行 統一&#x27;);

$(document).ready(function() {
	activate(&quot;data/test.json&quot;);
});

function activate(data) {
	// define arrow markers for graph links
	d3.select(&quot;svg&quot;).append(&quot;defs&quot;).append(&quot;marker&quot;).attr(&quot;id&quot;, &quot;branch&quot;).attr(&quot;viewBox&quot;, &quot;0 -5 10 10&quot;).attr(&quot;refX&quot;, 25).attr(&quot;refY&quot;, 0).attr(&quot;markerWidth&quot;, 5).attr(&quot;markerHeight&quot;, 5).attr(&quot;orient&quot;, &quot;auto&quot;).append(&quot;path&quot;).attr(&quot;fill&quot;, &quot;#0FF&quot;).attr(&quot;stroke&quot;, &quot;#0FF&quot;).attr(&quot;stroke-width&quot;, &quot;0.1px&quot;).attr(&quot;d&quot;, &quot;M0,-5L10,0L0,5Z&quot;);

	d3.select(&quot;defs&quot;).append(&quot;marker&quot;).attr(&quot;id&quot;, &quot;trade&quot;).attr(&quot;viewBox&quot;, &quot;0 -5 10 10&quot;).attr(&quot;refX&quot;, 25).attr(&quot;refY&quot;, 0).attr(&quot;markerWidth&quot;, 5).attr(&quot;markerHeight&quot;, 5).attr(&quot;orient&quot;, &quot;auto&quot;).append(&quot;path&quot;).attr(&quot;fill&quot;, &quot;#000&quot;).attr(&quot;stroke&quot;, &quot;#000&quot;).attr(&quot;stroke-width&quot;, &quot;0.1px&quot;).attr(&quot;d&quot;, &quot;M0,-5L10,0L0,5Z&quot;);

	d3.json(data, function(error, graph) {
		if (error) {
			console.error(error);
			return;
		}
		var types = [], nodeHash = {};
		// assign vertices to nodes array
		graph.vertices.forEach(function(vertex, i) {
			nodeHash[vertex._id] = i;

			nodes_ori.push({
				id : i.toString(),
				name : vertex.公司名稱,
				label : vertex.公司名稱,
				attributes : vertex,
				viz : {
					color : &quot;rgb(255,0,0)&quot;,
					size : 5,
					position : {
						x : Math.random() % 100,
						y : Math.random() % 100,
						z : 0
					}
				}
			});

			if (types.indexOf(vertex.type) === -1) {
				types.push(vertex.type);
			}
		});

		// assign edges to links array
		graph.edges.forEach(function(edge, i) {
			if (edge._label === &#x27;分支機構 &#x27;) {
				links_branch.push({
					id : i.toString(),
					attributes : edge,
					source : nodeHash[edge._outV].toString(),
					target : nodeHash[edge._inV].toString(),
					label : edge._label,
					weight : 1.0
				});
			} else {
				links_trade.push({
					id : i.toString(),
					attributes : edge,
					source : nodeHash[edge._outV].toString(),
					target : nodeHash[edge._inV].toString(),
					label : edge._label,
					weight : 1.0
				});
			}
		});

		loadGraph(nodes_ori, links_branch.concat(links_trade));
		createControls();

		force = d3.layout.force().charge(-1).linkDistance(1).size([1, 1]).gravity(0.1).on(&quot;tick&quot;, redrawGraph);
	});
}

function loadGraph(nodes, edges) {
	var newGEXF = GexfParser.fetch(&#x27;data/lm.gexf&#x27;);

	d3.selectAll(&quot;svg &gt; g &gt; *&quot;).remove();

	newGEXF.nodes = nodes;
	newGEXF.edges = edges;

	gD3 = gexfD3().graph(newGEXF).size([1000, 1000]).nodeScale([5, 20]);
}

function highlightNeighbors(d, i) {
	var nodeNeighbors = findNeighbors(d, i);

	d3.selectAll(&quot;g.node&quot;).each(function(p) {
		var isNeighbor = nodeNeighbors.nodes.indexOf(p);
		d3.select(this).select(&quot;circle&quot;).style(&quot;opacity&quot;, isNeighbor &gt; -1 ? 1 : 0.25).style(&quot;stroke-width&quot;, isNeighbor &gt; -1 ? 3 : 1).style(&quot;stroke&quot;, isNeighbor &gt; -1 ? &quot;blue&quot; : &quot;white&quot;);
	});

	path.style(&quot;opacity&quot;, function(d) {
		return nodeNeighbors.links.indexOf(d) &gt; -1 ? 1 : 0.25;
	});
}

function findNeighbors(d, i) {
	neighborArray = [d];
	var linkArray = [];
	var linksArray = path.filter(function(p) {
		return p.source == d || p.target == d;
	}).each(function(p) {
		if (neighborArray.indexOf(p.source) == -1) {
			var n = p.source;
			n.type = p.label;
			neighborArray.push(p.source);
		}
		if (neighborArray.indexOf(p.target) == -1) {
			var n = p.target;
			n.type = p.label;
			neighborArray.push(p.target);
		}
		linkArray.push(p);
	});
	return {
		nodes : neighborArray,
		links : linkArray
	};
}

function zoomed() {
	force.stop();
	var canvWidth = parseInt(d3.select(&quot;#vizcontainer&quot;).style(&quot;width&quot;));
	var canvHeight = parseInt(d3.select(&quot;#vizcontainer&quot;).style(&quot;height&quot;));

	currentScale = zoom.scale();
	var halfCanvas = canvHeight / 2;
	var zoomLevel = halfCanvas * currentScale;

	gD3.xScale().range([halfCanvas - zoomLevel, halfCanvas + zoomLevel]);
	gD3.yScale().range([halfCanvas + zoomLevel, halfCanvas - zoomLevel]);
	redrawGraph();

	var canvasTranslate = zoom.translate();
	d3.select(&quot;#graphG&quot;).attr(&quot;transform&quot;, &quot;translate(&quot; + canvasTranslate[0] + &quot;,&quot; + canvasTranslate[1] + &quot;)&quot;);
}

function createControls() {
	d3.select(&quot;#controls&quot;).append(&quot;button&quot;).attr(&quot;class&quot;, &quot;ui button green&quot;).html(&quot;Force On&quot;).on(&quot;click&quot;, function() {
		force.start();
	});
	d3.select(&quot;#controls&quot;).append(&quot;button&quot;).attr(&quot;class&quot;, &quot;ui button red&quot;).html(&quot;Force Off&quot;).on(&quot;click&quot;, function() {
		force.stop();
	});
	d3.select(&quot;#controls&quot;).append(&quot;button&quot;).attr(&quot;class&quot;, &quot;ui button blue&quot;).html(&quot;Reset Layout&quot;).on(&quot;click&quot;, function() {
		force.stop();
		gD3.nodes().forEach(function(el) {
			el.x = el.originalX;
			el.px = el.originalX;
			el.y = el.originalY;
			el.py = el.originalY;
		});
		currentBrush = [0, 0];
		draw();
		redrawGraph();
	});
	d3.select(&quot;#controls&quot;).append(&quot;button&quot;).attr(&quot;class&quot;, &quot;ui button&quot;).html(&quot;顯示分支機構關係&quot;).on(&quot;click&quot;, function() {
		force.stop();

		var n = filtered_nodes.length === 0 ? nodes_ori : filtered_nodes;
		var e = filtered_edges.length === 0 ? links_branch : filtered_edges;

		e = e.filter(function(edge) {
			return edge.label === &#x27;分支機構 &#x27;;
		});

		loadGraph(n, e);

		reloadForce();
	});
	d3.select(&quot;#controls&quot;).append(&quot;button&quot;).attr(&quot;class&quot;, &quot;ui button&quot;).html(&quot;顯示交易關係&quot;).on(&quot;click&quot;, function() {
		force.stop();

		var n = filtered_nodes.length === 0 ? nodes_ori : filtered_nodes;
		var e = filtered_edges.length === 0 ? links_trade : filtered_edges;

		e = e.filter(function(edge) {
			return edge.label === &#x27;交易關係&#x27;;
		});

		loadGraph(n, e);
		reloadForce();
	});
	d3.select(&quot;#controls&quot;).append(&quot;button&quot;).attr(&quot;class&quot;, &quot;ui button&quot;).html(&quot;顯示全部&quot;).on(&quot;click&quot;, function() {
		force.stop();

		var n = filtered_nodes.length === 0 ? nodes_ori : filtered_nodes;
		var e = filtered_edges.length === 0 ? links_trade : filtered_edges;

		loadGraph(n, e);
		reloadForce();
	});
}

function nodeButtonClick(d, i) {
	var nodeAttExtent = d3.extent(gD3.nodes(), function(p) {
		return parseFloat(p.properties[d]);
	});
	var colorScale = d3.scale.quantize().domain(nodeAttExtent).range(colorbrewer.YlGnBu[6]);
	d3.selectAll(&quot;circle&quot;).style(&quot;fill&quot;, function(p) {
		return colorScale(p.properties[d]);
	}).style(&quot;opacity&quot;, 1);
}

function linkButtonClick(d, i) {
	var linkAttExtent = d3.extent(gD3.links(), function(p) {
		return parseFloat(p.properties[d]);
	});
	var colorScale = d3.scale.quantize().domain(linkAttExtent).range(colorbrewer.YlGnBu[6]);
	d3.selectAll(&quot;line&quot;).style(&quot;stroke&quot;, function(p) {
		return colorScale(p.properties[d]);
	}).style(&quot;opacity&quot;, 1);
}

function redrawGraph() {
	var xScale = gD3.xScale();
	var yScale = gD3.yScale();

	path.attr(&quot;d&quot;, function(d) {
		var line;
		var dx = xScale(d.target.x) - xScale(d.source.x), dy = yScale(d.target.y) - yScale(d.source.y), dr = Math.sqrt(dx * dx + dy * dy) * 2 / d.properties._linknum;

		if (d.properties._linknum === 1) {
			line = &quot;M&quot; + xScale(d.source.x) + &quot;,&quot; + yScale(d.source.y) + &quot; l&quot; + dx + &quot;,&quot; + dy;
		} else {
			line = &quot;M&quot; + xScale(d.source.x) + &quot;,&quot; + yScale(d.source.y) + &quot; A&quot; + dr + &quot;,&quot; + dr + &quot; 0 0,1 &quot; + xScale(d.target.x) + &quot;,&quot; + yScale(d.target.y);
		}
		return line;
	});
	// .style(&quot;marker-end&quot;, function (d) { return d.label === &quot;分支機構 &quot; ? &quot;url(#arrow-branch)&quot; : &quot;url(#arrow-trade)&quot;; });

	d3.selectAll(&quot;g.node&quot;).attr(&quot;transform&quot;, function(d) {
		return &quot;translate(&quot; + xScale(d.x) + &quot;,&quot; + yScale(d.y) + &quot;)&quot;;
	});
}

function draw() {
	var xScale = gD3.xScale();
	var yScale = gD3.yScale();
	var sizeScale = gD3.nodeScale();

	var forceRunning = false;
	if (force.alpha() &gt; 0) {
		force.stop();
		forceRunning = true;
	}

	path.attr(&quot;d&quot;, function(d) {
		var line;
		var dx = xScale(d.target.x) - xScale(d.source.x), dy = yScale(d.target.y) - yScale(d.source.y), dr = Math.sqrt(dx * dx + dy * dy) * 2 / d.properties._linknum;
		if (d.properties._linknum === 1) {
			line = &quot;M&quot; + xScale(d.source.x) + &quot;,&quot; + yScale(d.source.y) + &quot; l&quot; + dx + &quot;,&quot; + dy;
		} else {
			line = &quot;M&quot; + xScale(d.source.x) + &quot;,&quot; + yScale(d.source.y) + &quot; A&quot; + dr + &quot;,&quot; + dr + &quot; 0 0,1 &quot; + xScale(d.target.x) + &quot;,&quot; + yScale(d.target.y);
		}
		return line;
	}).attr(&quot;transform&quot;, function(d) {
		return &quot;translate(&quot; + xScale(d.x) + &quot;,&quot; + yScale(d.y) + &quot;)&quot;;
	}).on(&quot;mouseover&quot;, edgeOver).on(&quot;mouseout&quot;, edgeOut).on(&quot;click&quot;, linkClick).style(&quot;stroke&quot;, function(d) {
		if (d.label === &#x27;分支機構 &#x27;) {
			return &#x27;cyan&#x27;;
		} else {
			return &#x27;black&#x27;;
		}
	}).style(&quot;stroke-width&quot;, &quot;2px&quot;).style(&quot;opacity&quot;, 0.7);

	d3.select(&quot;#graphG&quot;).selectAll(&quot;g.node&quot;).data(gD3.nodes(), function(d) {
		return d.id;
	}).enter().append(&quot;g&quot;).attr(&quot;class&quot;, &quot;node&quot;).attr(&quot;transform&quot;, function(d) {
		return &quot;translate(&quot; + xScale(d.x) + &quot;,&quot; + yScale(d.y) + &quot;)&quot;;
	}).on(&quot;mouseover&quot;, nodeOver).on(&quot;mouseout&quot;, nodeOut).on(&quot;click&quot;, nodeClick).append(&quot;circle&quot;).attr(&quot;r&quot;, function(d) {
		return findNeighbors(d, 0).nodes.length + 6;
	}).style(&quot;fill&quot;, function(d) {
		for (var i = 0; i &lt; highlight_nodes.length; i++) {
			if (d.properties._id === highlight_nodes[i].attributes._id) {
				return &#x27;rgb(0, 255, 0)&#x27;;
			}
		}
		return d.rgbColor;
	}).style(&quot;stroke&quot;, &quot;black&quot;).style(&quot;stroke-width&quot;, &quot;1px&quot;).style(&quot;stroke-opacity&quot;, 1);

	force.nodes(gD3.nodes()).links(gD3.links());

	function nodeOver(d, i, e) {
		var el = this;
		if (!d3.event.fromElement) {
			el = e;
		}
		if (nodeFocus) {
			return;
		}

		//Only do the element stuff if this came from mouseover
		el.parentNode.appendChild(el);

		d3.select(el).append(&quot;text&quot;).attr(&quot;class&quot;, &quot;hoverLabel&quot;).attr(&quot;stroke&quot;, &quot;white&quot;).style(&quot;opacity&quot;, 0.9).style(&quot;pointer-events&quot;, &quot;none&quot;).text(d.label);

		d3.select(el).append(&quot;text&quot;).attr(&quot;class&quot;, &quot;hoverLabel&quot;).style(&quot;pointer-events&quot;, &quot;none&quot;).text(d.label);

		highlightNeighbors(d, i);
	}

	function edgeOver(d, i, e) {
		var el = this;
		if (!d3.event.fromElement) {
			el = e;
		}
		if (edgeFocus) {
			return;
		}

		var neighborN = [d.source, d.target];

		path.style(&quot;opacity&quot;, function(edge) {
			return [d].indexOf(edge) &gt; -1 ? 1 : 0.25;
		});

		d3.selectAll(&quot;g.node&quot;).each(function(p) {
			var isNeighbor = neighborN.indexOf(p);
			d3.select(this).select(&quot;circle&quot;).style(&quot;opacity&quot;, isNeighbor &gt; -1 ? 1 : 0.25).style(&quot;stroke-width&quot;, isNeighbor &gt; -1 ? 3 : 1).style(&quot;stroke&quot;, isNeighbor &gt; -1 ? &quot;blue&quot; : &quot;white&quot;);
		});
	}

	function nodeClick(d, i) {
		nodeFocus = false;
		nodeOut();
		nodeOver(d, i, this);
		nodeFocus = true;

		var newContent = &quot;&lt;h4 style=&#x27;text-align:center;&#x27;&gt;&quot; + d.label + &quot;&lt;/h4&gt;&quot;;
		newContent += &quot;&lt;p&gt;Attributes: &lt;/p&gt;&lt;p&gt;&lt;ul&gt;&quot;;
		for (x in gD3.nodeAttributes()) {
			if (Boolean(d.properties[gD3.nodeAttributes()[x]]) &amp;&amp; d.properties[gD3.nodeAttributes()[x]] !== &#x27;null&#x27;) {
				newContent += &quot;&lt;li&gt;&quot; + gD3.nodeAttributes()[x] + &quot;: &quot; + d.properties[gD3.nodeAttributes()[x]] + &quot;&lt;/li&gt;&quot;;
			}
		}
		newContent += &quot;&lt;/ul&gt;&lt;/p&gt;&lt;p&gt;Connections:&lt;/p&gt;&lt;ul&gt;&quot;;
		var neighbors = findNeighbors(d, i);
		for (x in neighbors.nodes) {
			if (neighbors.nodes[x] != d) {
				newContent += &quot;&lt;li&gt;&quot; + neighbors.nodes[x].type.trim() + &quot; ：&quot; + neighbors.nodes[x].label + &quot;&lt;/li&gt;&quot;;
			}
		}
		newContent += &quot;&lt;/ul&gt;&lt;/p&gt;&quot;;

		d3.select(&quot;#modal&quot;).style(&quot;display&quot;, &quot;block&quot;).select(&quot;#content&quot;).html(newContent);
	}

	function linkClick(d, i) {
		edgeFocus = false;
		edgeOut();
		edgeOver(d, i, this);
		edgeFocus = true;

		var newContent = &quot;&lt;p&gt;&quot; + d.label + &quot;&lt;/p&gt;&quot;;
		newContent += &quot;&lt;p&gt;Attributes: &lt;/p&gt;&lt;p&gt;&lt;ul&gt;&quot;;

		for (x in d.properties) {
			newContent += &quot;&lt;li&gt;&quot; + x + &quot;: &quot; + d.properties[x] + &quot;&lt;/li&gt;&quot;;
		}

		newContent += &quot;&lt;/ul&gt;&lt;/p&gt;&quot;;

		d3.select(&quot;#modal&quot;).style(&quot;display&quot;, &quot;block&quot;).select(&quot;#content&quot;).html(newContent);
	}

}

function nodeOut() {
	if (nodeFocus) {
		return;
	}

	d3.selectAll(&quot;.hoverLabel&quot;).remove();
	d3.selectAll(&quot;circle&quot;).style(&quot;opacity&quot;, 1).style(&quot;stroke&quot;, &quot;black&quot;).style(&quot;stroke-width&quot;, &quot;2px&quot;);
	path.style(&quot;opacity&quot;, 0.7);
	//d3.selectAll(&quot;line&quot;).style(&quot;opacity&quot;, 0.8);
}

function edgeOut() {
	if (edgeFocus) {
		return;
	}
	nodeOut();
}

function reloadForce() {
	currentBrush = [0, 0];
	force = d3.layout.force().charge(-1).linkDistance(1).size([1, 1]).gravity(0.1).on(&quot;tick&quot;, redrawGraph);

	zoom = d3.behavior.zoom().scaleExtent([0.01, 3]).on(&quot;zoom&quot;, zoomed).scale(0.04);

	allLinks = gD3.links();

	// add the links and the arrows
	path = d3.select(&quot;#graphG&quot;).append(&quot;g&quot;).selectAll(&quot;path&quot;).data(allLinks).enter().append(&quot;path&quot;).attr(&quot;class&quot;, &quot;link&quot;).style(&quot;marker-end&quot;, function(d) {
		return d.label === &quot;分支機構 &quot; ? &quot;url(#branch)&quot; : &quot;url(#trade)&quot;;
	});

	d3.select(&quot;svg&quot;).call(zoom).attr(&quot;transform&quot;, &quot;scale(.04,.04)&quot;);
	zoomed();
	draw();

	force.start();
}

//////////////////////////////////////////////////////////////////////////////////////

function query(type) {
	filtered_nodes = nodes_ori;
	filtered_edges = links_branch.concat(links_trade);

	var v, p, l, t;
	if (type === &#x27;node&#x27;) {
		v = $(&#x27;#query_node&#x27;).val();
		p = $(&#x27;#node_property&#x27;).val();
		l = $(&#x27;#searchLevel&#x27;).val();

		highlight_nodes = filtered_nodes.filter(function(n) {
			return n.attributes[p].indexOf(v) !== -1;
		});
		var r = findAllRelations(highlight_nodes, l);
		filtered_edges = r.edges;
		filtered_nodes = r.nodes;
	} else {
		v = parseInt($(&#x27;#query_edge&#x27;).val(), 10);
		p = $(&#x27;#edge_property&#x27;).val();
		t = $(&#x27;#searchType&#x27;).val();
		l = 1;

		if (p === &#x27;商品名稱&#x27;) {
			highlight_edges = filtered_edges.filter(function(e) {
				if (e.label !== &#x27;交易關係&#x27;) {
					return false;
				}
				return e.attributes[p].indexOf($(&#x27;#query_edge&#x27;).val()) !== -1;
			});
		} else {
			highlight_edges = filtered_edges.filter(function(e) {
				if (e.label !== &#x27;交易關係&#x27;) {
					return false;
				}
				if (t === &#x27;eq&#x27;) {
					return e.attributes[p] === v;
				}
				if (t === &#x27;gt&#x27;) {
					return e.attributes[p] &gt; v;
				}
				if (t === &#x27;lt&#x27;) {
					return e.attributes[p] &lt; v;
				}
			});
		}
		var n = findNodes(highlight_edges);

		filtered_edges = highlight_edges;
		filtered_nodes = n;
	}

	//console.log(filtered_nodes.length, filtered_edges.length);

	//////////////////////////////

	if (filtered_nodes.length &gt; 0) {
		//sort links by source, then target
		filtered_edges.sort(function(a, b) {
			if (a.source &gt; b.source) {
				return 1;
			} else if (a.source &lt; b.source) {
				return -1;
			} else {
				if (a.target &gt; b.target) {
					return 1;
				}
				if (a.target &lt; b.target) {
					return -1;
				} else {
					return 0;
				}
			}
		});
		//any links with duplicate source and target get an incremented &#x27;_linknum&#x27;
		for (var i = 0; i &lt; filtered_edges.length; i++) {
			if (i !== 0 &amp;&amp; filtered_edges[i].source == filtered_edges[i - 1].source &amp;&amp; filtered_edges[i].target == filtered_edges[i - 1].target) {
				filtered_edges[i].attributes._linknum = filtered_edges[i - 1].attributes._linknum + 1;
			} else {
				filtered_edges[i].attributes._linknum = 1;
			}
		}
		loadGraph(filtered_nodes, filtered_edges);
		reloadForce();
	} else {
		d3.selectAll(&quot;svg &gt; g &gt; *&quot;).remove();
	}
}

function findAllRelations(nodes, level) {
	var r_edges = [], r_nodes = nodes;
	var search_level = 0;

	while (true) {
		search_level++;
		if (search_level &gt; level)
			break;

		var e = findEdges(r_nodes);
		var n = findNodes(e);

		if (JSON.stringify(e) === JSON.stringify(r_edges) &amp;&amp; JSON.stringify(n) === JSON.stringify(r_nodes)) {
			break;
		} else {
			r_edges = e;
			r_nodes = n;
		}
	}

	return {
		nodes : r_nodes,
		edges : r_edges
	};
}

function findEdges(nodes) {
	var edges = links_branch.concat(links_trade).filter(function(e) {
		var ans = false;
		for (var i = 0; i &lt; nodes.length; i++) {
			ans = (nodes[i].attributes._id === e.attributes._inV || nodes[i].attributes._id === e.attributes._outV);
			if (ans)
				return ans;
		}
		return ans;
	});
	return edges;
}

function findNodes(edges) {
	var nodes = nodes_ori.filter(function(n) {
		var ans = false;
		for (var i = 0; i &lt; edges.length; i++) {
			ans = (n.attributes._id === edges[i].attributes._inV || n.attributes._id === edges[i].attributes._outV);
			if (ans)
				return ans;
		}
		return ans;
	});
	return nodes;
}

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
